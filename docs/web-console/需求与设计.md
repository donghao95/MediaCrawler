# 本地 Web 管理台（无登录）需求与设计

## 一、背景与目标
- 背景：MediaCrawler 已支持多平台采集并落地 SQLite/MySQL/CSV/JSON，当前以命令行“跑一轮即结束”为主，缺少可视化与常驻能力。
- 目标：为个人本地使用提供一个简单稳定的 Web 管理台，便于可视化地创建/运行/监控任务、浏览与导出结果、管理关键配置；不包含用户登录/权限。

## 二、范围与优先级
- P0（MVP）
  - 任务管理：创建/编辑/复制/删除/运行/取消，支持简单定时（间隔或 Cron）。
  - 运行监控：实时日志（SSE/WS）与进度（已抓条数、速率、耗时、预估剩余）。
  - 结果浏览：按平台/关键词/时间筛选列表，详情（含评论分页），导出 CSV/JSON。
  - 配置管理：评论/二级评论、并发、最大抓取量、是否抓媒体、代理开关、CDP 开关等。
  - 健康检查：运行状态/版本/依赖检查（Node/Playwright）。
- P1
  - 队列与并发上限控制、失败重试、运行历史统计。
  - 二级评论可视化与独立开关。
  - 简单报表（按平台/关键词趋势）。
- P2
  - 告警通知（失败/异常/风控触发）邮件/企业 IM。
  - 多用户/权限（非本项目当前需要）。

## 三、用户与角色
- 单用户（本地使用）：拥有所有权限；无登录流程。

## 四、关键业务流程
1) 创建任务 → 选择平台/抓取类型/关键词/评论开关/保存方式/并发/限制 → 保存。
2) 手动运行或按计划调度 → 后台子进程执行爬虫 → 实时产生日志/进度 → 结束落库。
3) 结果浏览 → 列表筛选 → 详情（含评论分页/媒体链接）→ 导出。
4) 配置页调整基础参数（影响后续任务或即时应用，需标注作用域）。

## 五、功能需求明细（P0）
### 5.1 任务管理
- 任务 CRUD：名称、平台（xhs/dy/ks/bili/wb/tieba/zhihu）、抓取类型（search/detail/creator）、关键词（逗号分隔）、评论/二级评论开关、保存方式（sqlite/db/csv/json）、起始页、最大抓取量、单贴评论上限、是否抓媒体、并发、代理开关、计划类型（none/interval/cron）、计划表达式/间隔。
- 运行控制：手动运行、取消；查看历史运行列表（成功/失败/取消、耗时、条数、错误摘要）。

### 5.2 运行监控
- 实时日志流：显示 MediaCrawler 的 stdout/stderr，支持级别筛选（INFO/ERROR）。
- 进度：已抓帖子数、已抓评论数、当前页/总页（估算）、速率、预估剩余时间。

### 5.3 结果浏览/导出
- 列表：平台、标题/内容、评论数、发布时间、关键词、是否含媒体。
- 过滤：平台、关键词、时间范围、评论数范围、是否含二级评论。
- 详情：帖子/视频详情页，评论分页（搜索/排序），媒体链接展示。
- 导出：按当前筛选导出 CSV/JSON。

### 5.4 配置管理
- 基础配置可视化：评论开关、二级评论开关、并发、最大抓取量、是否抓媒体、代理开关/提供商、CDP 开关、起始页。
- 登录态提示：展示各平台登录状态与扫码登录引导（仅提示）。

### 5.5 健康/系统
- 健康检查、版本信息、依赖检测（Node、Playwright 安装状态）。

### 5.6 客户端能力总览
- 一键开始/停止；实时进度面板（已抓帖子/评论、当前页/总页、速率、ETA、错误数）
- 实时日志窗口（级别筛选），错误高亮
- 参数前端可配：平台、抓取类型、关键词/链接、登录方式（二维码/手机号/Cookie）、并发、是否抓媒体/评论/二级评论、保存方式（sqlite/db/csv/json）、代理/CDP、起始页、最大抓取量等
- 登录态入口：扫码/输入 Cookie/手机号登录引导；后端更新登录态
- 结果：卡片瀑布流 + 详情抽屉（图片/视频预览、评论/二级评论分页）
- 计划任务与历史运行：interval/cron、历史列表、再次运行、错误摘要、日志查看/导出
- 导出：按筛选导出 CSV/JSON

## 六、非功能需求
- 可用性：常驻运行稳定，任务失败不影响前端可用。
- 性能：列表分页≤1s；单页 20-50 条；10 万级数据可用。
- 并发：默认 1-2；全局/每平台并发上限可配。
- 安全：本地使用，无登录；提供“仅本机访问”配置；敏感配置以脱敏显示。
- 观测：结构化日志、错误堆栈、任务运行指标（耗时/条数）。
- 部署：Windows 便捷启动（Uvicorn），可注册为服务/开机启动。

## 七、总体架构设计（桌面客户端形态）
- 前端（客户端）：Electron + Vue3 + TypeScript + Vite + Element Plus（桌面应用外壳，UI 用 Web 技术）
- 后端（本地服务）：Python + Tornado + Httpx + Pydantic（REST + WebSocket），内置静态文件服务
- 启动形态：Electron 主进程拉起 Tornado（监听 127.0.0.1:<port>），渲染进程通过 HTTP/WS 调用，仅本机可访问
- 任务执行：后端以子进程/协程方式调用现有爬虫，采集 stdout/结构化事件，实时推送前端
- 数据：复用现有 SQLite/MySQL 表；为客户端新增少量管理表（任务/运行/设置）

## 八、数据模型（新增）
```sql
-- 任务定义
CREATE TABLE IF NOT EXISTS web_task (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  platform TEXT NOT NULL,
  crawler_type TEXT NOT NULL,
  keywords TEXT,
  get_comments INTEGER NOT NULL,
  get_sub_comments INTEGER NOT NULL,
  save_data_option TEXT NOT NULL,
  start_page INTEGER NOT NULL DEFAULT 1,
  max_notes_count INTEGER NOT NULL DEFAULT 200,
  max_comments_per_note INTEGER NOT NULL DEFAULT 10,
  enable_media INTEGER NOT NULL DEFAULT 0,
  enable_proxy INTEGER NOT NULL DEFAULT 0,
  concurrency INTEGER NOT NULL DEFAULT 1,
  schedule_type TEXT NOT NULL DEFAULT 'none',
  schedule_value TEXT,
  enabled INTEGER NOT NULL DEFAULT 1,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 任务运行
CREATE TABLE IF NOT EXISTS web_task_run (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL,
  status TEXT NOT NULL,              -- pending/running/success/failed/canceled
  pid INTEGER,
  started_at INTEGER,
  finished_at INTEGER,
  total_notes INTEGER DEFAULT 0,
  total_comments INTEGER DEFAULT 0,
  error_message TEXT,
  args_json TEXT,
  log_path TEXT,
  FOREIGN KEY(task_id) REFERENCES web_task(id)
);

-- 运行日志（可选；或仅写文件）
CREATE TABLE IF NOT EXISTS web_task_run_event (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  run_id INTEGER NOT NULL,
  ts INTEGER NOT NULL,
  level TEXT NOT NULL,
  message TEXT NOT NULL,
  FOREIGN KEY(run_id) REFERENCES web_task_run(id)
);

-- 设置（K/V）
CREATE TABLE IF NOT EXISTS web_setting (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
);
```

## 九、API 设计（P0 摘要）
- 任务：
  - GET `/api/tasks`（分页/过滤）
  - POST `/api/tasks`（创建）
  - GET `/api/tasks/{id}`（详情）
  - PUT `/api/tasks/{id}`（更新）
  - DELETE `/api/tasks/{id}`（删除）
  - POST `/api/tasks/{id}/run`（手动运行）
  - POST `/api/tasks/{id}/cancel`（取消运行）
  - GET `/api/tasks/{id}/runs`（运行历史）
- 运行与日志：
  - GET `/api/runs/{run_id}`（运行详情）
  - GET `/api/runs/{run_id}/logs`（日志分页或文件 offset）
  - GET `/api/runs/{run_id}/stream`（SSE/WS 实时日志）
- 结果数据：
  - GET `/api/notes`（列表/过滤）
  - GET `/api/notes/{note_id}`（详情）
  - GET `/api/notes/{note_id}/comments`（分页）
  - GET `/api/export/notes.csv`、`/api/export/comments.csv`
- 设置/健康：
  - GET/PUT `/api/settings`
  - GET `/api/health`

说明：字段命名风格统一（建议 snake_case），列表接口返回 total/page/page_size。

### 9.1 WebSocket 事件模型（示例）
前端通过 `WS /ws/runs/{run_id}` 订阅事件流，驱动进度与 UI 刷新：

```json
{ "type": "status", "run_id": "r1", "status": "running" }
{ "type": "metric", "run_id": "r1", "notes": 120, "comments": 980, "page": 3, "page_total": 10, "rate": 45.2, "eta_sec": 380 }
{ "type": "log", "level": "INFO", "message": "[xhs] page=3 fetched 20 notes" }
{ "type": "card", "note": { "platform":"xhs", "note_id":"...", "title":"...", "cover":"http://127.0.0.1:8000/static/...jpg", "comment_count":52, "time":1754635 } }
{ "type": "error", "message":"Timeout on playwright", "note_id":"...", "retry":1 }
{ "type": "done", "status":"success", "summary": { "notes": 260, "comments": 2100, "duration_sec": 900 } }
```

### 9.2 登录与会话（补充）
- GET `/api/login/state?platform=xhs` → { status: ok|need_login, detail }
- POST `/api/login/cookie` { platform, cookies } → { ok }
- POST `/api/login/clear` { platform } → { ok }

### 9.3 代理与网络（补充）
- PUT `/api/settings/proxy` { enable_proxy, provider_name, pool_count, auth } → { ok }
- GET `/api/proxy/test` → { ok, ip, latency_ms }

### 9.4 解析与工具（补充）
- POST `/api/parse` { platform, type: "detail|creator", value: "urlOrId" } → { id, xsec_source?, xsec_token? }

### 9.5 静态资源（说明）
- `/static/notes/{note_id}/...` 暴露图片/视频/词云等文件，供前端直接预览与下载

### 9.6 安全（说明）
- 仅监听 `127.0.0.1`；不暴露公网；敏感配置（如代理密钥、Cookie）仅提供脱敏回显

## 十、运行与调度设计
- 子进程执行命令：
  - 基础：`python main.py --platform ... --type ... --keywords ... --save_data_option ...`
  - 捕获 stdout/stderr 写入文件与事件表；解析关键日志行抓取进度指标。
- 定时调度：
  - 使用 APScheduler；FastAPI 启动时加载任务；支持“间隔/cron/关闭”。
- 并发互斥：
  - 全局/每平台并发上限；超限进入队列；取消任务向子进程发送终止信号并清理资源。

## 十一、前端页面（信息架构）
- 控制台：运行中任务、今日产出、失败率（P1 可加）。
- 任务列表 → 新建/编辑 → 运行详情（实时日志+进度）。
- 数据浏览：帖子/视频列表、筛选、详情抽屉（含评论分页/媒体链接）、导出按钮。
- 设置页：基础配置项、依赖检测、登录态提示。

### 11.1 媒体与词云（约定）
- 图片：仅保存原图，列表直接展示图片封面，详情可预览原图（后续可选加缩略图）。
- 视频：仅保存 MP4，不做自动截帧；封面优先用平台返回的封面字段，缺省显示占位图；详情内 `<video>` 播放。
- 词云图：后端生成 PNG 文件（以及词频 JSON），前端直接展示 PNG（如需交互再读取 JSON）。
- 静态文件服务：`/static/notes/{note_id}/...` 对应图片/视频/词云等文件路径。

### 11.2 内容卡片瀑布流规范
- 卡片字段：封面（图片/平台封面/占位图）、标题、作者昵称、发布时间、评论数/点赞数、抓取状态徽标
- 交互：
  - 点击卡片 → 打开详情抽屉（媒体预览、评论分页、标签）
  - 卡片右上角：下载/打开所在目录/复制链接/导出单条
  - 卡片底部：来源关键词标签、平台徽标

### 11.3 UI 布局与导航
- 顶部栏（固定）
  - 应用标题 + 全局搜索（按 note_id/标题/作者）
  - 右侧：运行状态小圆点（idle/running/failed）、当前任务名、最小化/关闭
- 左侧边栏（固定宽度）
  - 平台选择：抖音/小红书/快手/B站/微博/贴吧/知乎（支持徽标与当前登录态提示）
  - 爬取类型：search/detail/creator（单选）
  - 输入区（随类型联动）
    - search：关键词输入（逗号分隔）
    - detail：帖子链接/ID 输入
    - creator：创作者链接/ID 输入
  - 登录方式
    - 二维码登录按钮（打开浏览器扫码）
    - Cookie 文本框（多行），“校验并保存”按钮
    - 手机号登录（手机号、验证码/短信回调说明，后续扩展）
  - 参数折叠面板
    - 是否抓媒体/评论/二级评论、并发、起始页、最大抓取量、保存方式（sqlite/db/csv/json）、代理/CDP 开关等
  - 主按钮区
    - 开始爬取（primary）/ 停止（危险态）
- 右侧主工作区（可切换 3 个视图 tab）
  - 运行视图（默认）
    - 顶部进度面板：已抓帖子/评论、页码/总页、速率、ETA、错误数
    - 实时日志控制台：级别筛选、自动追尾、复制、清屏
    - 当前关键词/任务摘要
  - 内容视图
    - 顶部过滤器：平台、关键词、时间范围、评论数范围、是否含媒体、排序
    - 瀑布流卡片（无限滚动或分页）
  - 任务视图
    - 任务模板列表、历史运行列表（状态/耗时/条数/错误摘要），支持再次运行

### 11.4 关键交互流程
- 开始爬取
  1) 点击“开始爬取” → 后端创建 run，并返回 run_id
  2) 前端切换到“运行视图”，订阅 `/ws/runs/{run_id}`
  3) 按 WS 事件刷新进度与日志；禁用会影响本次运行的参数表单
  4) 可随时“停止”（二次确认），后端发取消信号；结束后弹出摘要
- 查看结果
  1) 切到“内容视图”，按需选择过滤条件
  2) 浏览瀑布流卡片；点击进入详情抽屉
  3) 详情内：媒体预览、评论分页、复制链接/打开目录/导出单条
- 导出
  - 在内容视图选择过滤条件后点击“导出 CSV/JSON” → 由后端按筛选生成文件并返回下载 URL

### 11.5 登录交互细节
- 二维码登录
  - 点击按钮 → 弹引导（将打开浏览器扫码）→ 打开浏览器至平台登录页（CDP/Playwright 维持）→ 完成后后端更新 Cookie，前端状态灯变绿
- Cookie 登录
  - 粘贴 Cookie 多行文本 → 点击“校验并保存”→ 后端尝试 `pong()`；成功则绿灯、失败给出错误提示
- 手机号登录（预留）
  - 输入手机号、验证码：校验接口/或走 `recv_sms.py` 回调缓存短信码（后续实现）

### 11.6 进度与状态显示规范
- 状态枚举：idle / pending / running / success / failed / canceled
- 指标：已抓帖子、已抓评论、当前页/总页（估算）、速率（条/分钟）、ETA、错误数、当前关键词/帖子ID
- 日志：INFO/ERROR 过滤；自动追尾；复制；清屏；导出日志文件
- 错误提示：toast + 日志行高亮；累计错误计数

### 11.7 操作反馈与异常处理
- 空态：未运行时显示三步引导（选择平台 → 输入/登录 → 点击开始）
- 停止确认：防误触弹窗（确认/取消）
- 权限/网络：无法连接后端/媒体文件不存在 → 统一错误页与重试按钮
- 目录权限：打开目录失败时 toast 提示；提供复制路径

## 十二、关键实现要点
- 复用现有采集/落库逻辑；客户端仅负责“编排与可视化”。
- 优先“子进程 + stdout 日志解析 + 结果库读取 + WS 事件”，避免大改 crawler。
- 进度估算：已处理页/总页（估算）、已落库条数/目标上限。
- 去重：沿用 DB/SQLite upsert；前端展示“新增/更新”的计数。

## 十三、部署与运维
- 依赖：Electron、Vue3、Tornado、APScheduler、aiosqlite/SQLAlchemy、httpx、pydantic（词云需 matplotlib/wordcloud）
- 启动：Electron 主进程启动 Tornado（仅监听 127.0.0.1），渲染进程调用；开发时可单独启动 Tornado 调试
- Windows 常驻：Electron 自身常驻；如需服务化可配 WinSW/NSSM 拉起 Tornado（开发阶段）
- 日志：按任务/日期切分；定期清理；SQLite 周期性备份；媒体目录空间告警（后续）
- 安全：仅本机监听；不暴露公网；敏感配置脱敏展示

## 十四、里程碑（建议，桌面客户端）
- M1（3-5 天）：MVP（P0）——任务 CRUD、手动运行/停止、实时进度与日志（WS）、结果列表与详情（媒体预览）、导出、词云 PNG 显示
- M2（5-7 天）：计划任务、运行历史、取消/重试、更丰富的筛选与导出、错误摘要
- M3（5-7 天）：登录态面板、简报表、告警、Electron 打包与自动更新（可选）、文档

## 十五、风险与边界
- Playwright/扫码登录交互：仅能通过子进程弹出浏览器引导扫码。
- 平台反爬变化：需良好日志与重试策略。
- SQLite 并发写：crawler 写库、Web 只读为主；如同时写入需注意连接与事务。

## 十六、Electron 主进程职责（补充）
- 启动/停止 Tornado 子进程；端口占用检测与切换；崩溃重启
- 进程心跳与日志落地；异常托底对话提示
- 系统托盘、开机自启（可选）；自动更新（可选）


