# 本地 Web 管理台（无登录）需求与设计

## 一、背景与目标
- 背景：MediaCrawler 已支持多平台采集并落地 SQLite/MySQL/CSV/JSON，当前以命令行“跑一轮即结束”为主，缺少可视化与常驻能力。
- 目标：为个人本地使用提供一个简单稳定的 Web 管理台，便于可视化地创建/运行/监控任务、浏览与导出结果、管理关键配置；不包含用户登录/权限。

## 二、范围与优先级
- P0（MVP）
  - 任务管理：创建/编辑/复制/删除/运行/取消，支持简单定时（间隔或 Cron）。
  - 运行监控：实时日志（SSE/WS）与进度（已抓条数、速率、耗时、预估剩余）。
  - 结果浏览：按平台/关键词/时间筛选列表，详情（含评论分页），导出 CSV/JSON。
  - 配置管理：评论/二级评论、并发、最大抓取量、是否抓媒体、代理开关、CDP 开关等。
  - 健康检查：运行状态/版本/依赖检查（Node/Playwright）。
- P1
  - 队列与并发上限控制、失败重试、运行历史统计。
  - 二级评论可视化与独立开关。
  - 简单报表（按平台/关键词趋势）。
- P2
  - 告警通知（失败/异常/风控触发）邮件/企业 IM。
  - 多用户/权限（非本项目当前需要）。

## 三、用户与角色
- 单用户（本地使用）：拥有所有权限；无登录流程。

## 四、关键业务流程
1) 创建任务 → 选择平台/抓取类型/关键词/评论开关/保存方式/并发/限制 → 保存。
2) 手动运行或按计划调度 → 后台子进程执行爬虫 → 实时产生日志/进度 → 结束落库。
3) 结果浏览 → 列表筛选 → 详情（含评论分页/媒体链接）→ 导出。
4) 配置页调整基础参数（影响后续任务或即时应用，需标注作用域）。

## 五、功能需求明细（P0）
### 5.1 任务管理
- 任务 CRUD：名称、平台（xhs/dy/ks/bili/wb/tieba/zhihu）、抓取类型（search/detail/creator）、关键词（逗号分隔）、评论/二级评论开关、保存方式（sqlite/db/csv/json）、起始页、最大抓取量、单贴评论上限、是否抓媒体、并发、代理开关、计划类型（none/interval/cron）、计划表达式/间隔。
- 运行控制：手动运行、取消；查看历史运行列表（成功/失败/取消、耗时、条数、错误摘要）。

### 5.2 运行监控
- 实时日志流：显示 MediaCrawler 的 stdout/stderr，支持级别筛选（INFO/ERROR）。
- 进度：已抓帖子数、已抓评论数、当前页/总页（估算）、速率、预估剩余时间。

### 5.3 结果浏览/导出
- 列表：平台、标题/内容、评论数、发布时间、关键词、是否含媒体。
- 过滤：平台、关键词、时间范围、评论数范围、是否含二级评论。
- 详情：帖子/视频详情页，评论分页（搜索/排序），媒体链接展示。
- 导出：按当前筛选导出 CSV/JSON。

### 5.4 配置管理
- 基础配置可视化：评论开关、二级评论开关、并发、最大抓取量、是否抓媒体、代理开关/提供商、CDP 开关、起始页。
- 登录态提示：展示各平台登录状态与扫码登录引导（仅提示）。

### 5.5 健康/系统
- 健康检查、版本信息、依赖检测（Node、Playwright 安装状态）。

## 六、非功能需求
- 可用性：常驻运行稳定，任务失败不影响前端可用。
- 性能：列表分页≤1s；单页 20-50 条；10 万级数据可用。
- 并发：默认 1-2；全局/每平台并发上限可配。
- 安全：本地使用，无登录；提供“仅本机访问”配置；敏感配置以脱敏显示。
- 观测：结构化日志、错误堆栈、任务运行指标（耗时/条数）。
- 部署：Windows 便捷启动（Uvicorn），可注册为服务/开机启动。

## 七、总体架构设计
- 前端：
  - 方案 A：React + Vite + Ant Design（推荐）。
  - 方案 B：Jinja2 模板（更快落地，交互简单）。
- 后端：FastAPI + Uvicorn；APScheduler 调度；子进程运行爬虫；SSE/WS 推送日志。
- 数据：复用现有 SQLite/MySQL 表；新增少量 Web 管理表。

## 八、数据模型（新增）
```sql
-- 任务定义
CREATE TABLE IF NOT EXISTS web_task (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  platform TEXT NOT NULL,
  crawler_type TEXT NOT NULL,
  keywords TEXT,
  get_comments INTEGER NOT NULL,
  get_sub_comments INTEGER NOT NULL,
  save_data_option TEXT NOT NULL,
  start_page INTEGER NOT NULL DEFAULT 1,
  max_notes_count INTEGER NOT NULL DEFAULT 200,
  max_comments_per_note INTEGER NOT NULL DEFAULT 10,
  enable_media INTEGER NOT NULL DEFAULT 0,
  enable_proxy INTEGER NOT NULL DEFAULT 0,
  concurrency INTEGER NOT NULL DEFAULT 1,
  schedule_type TEXT NOT NULL DEFAULT 'none',
  schedule_value TEXT,
  enabled INTEGER NOT NULL DEFAULT 1,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 任务运行
CREATE TABLE IF NOT EXISTS web_task_run (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL,
  status TEXT NOT NULL,              -- pending/running/success/failed/canceled
  pid INTEGER,
  started_at INTEGER,
  finished_at INTEGER,
  total_notes INTEGER DEFAULT 0,
  total_comments INTEGER DEFAULT 0,
  error_message TEXT,
  args_json TEXT,
  log_path TEXT,
  FOREIGN KEY(task_id) REFERENCES web_task(id)
);

-- 运行日志（可选；或仅写文件）
CREATE TABLE IF NOT EXISTS web_task_run_event (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  run_id INTEGER NOT NULL,
  ts INTEGER NOT NULL,
  level TEXT NOT NULL,
  message TEXT NOT NULL,
  FOREIGN KEY(run_id) REFERENCES web_task_run(id)
);

-- 设置（K/V）
CREATE TABLE IF NOT EXISTS web_setting (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
);
```

## 九、API 设计（P0 摘要）
- 任务：
  - GET `/api/tasks`（分页/过滤）
  - POST `/api/tasks`（创建）
  - GET `/api/tasks/{id}`（详情）
  - PUT `/api/tasks/{id}`（更新）
  - DELETE `/api/tasks/{id}`（删除）
  - POST `/api/tasks/{id}/run`（手动运行）
  - POST `/api/tasks/{id}/cancel`（取消运行）
  - GET `/api/tasks/{id}/runs`（运行历史）
- 运行与日志：
  - GET `/api/runs/{run_id}`（运行详情）
  - GET `/api/runs/{run_id}/logs`（日志分页或文件 offset）
  - GET `/api/runs/{run_id}/stream`（SSE/WS 实时日志）
- 结果数据：
  - GET `/api/notes`（列表/过滤）
  - GET `/api/notes/{note_id}`（详情）
  - GET `/api/notes/{note_id}/comments`（分页）
  - GET `/api/export/notes.csv`、`/api/export/comments.csv`
- 设置/健康：
  - GET/PUT `/api/settings`
  - GET `/api/health`

说明：字段命名风格统一（建议 snake_case），列表接口返回 total/page/page_size。

## 十、运行与调度设计
- 子进程执行命令：
  - 基础：`python main.py --platform ... --type ... --keywords ... --save_data_option ...`
  - 捕获 stdout/stderr 写入文件与事件表；解析关键日志行抓取进度指标。
- 定时调度：
  - 使用 APScheduler；FastAPI 启动时加载任务；支持“间隔/cron/关闭”。
- 并发互斥：
  - 全局/每平台并发上限；超限进入队列；取消任务向子进程发送终止信号并清理资源。

## 十一、前端页面（信息架构）
- 控制台：运行中任务、今日产出、失败率（P1 可加）。
- 任务列表 → 新建/编辑 → 运行详情（实时日志+进度）。
- 数据浏览：帖子/视频列表、筛选、详情抽屉（含评论分页/媒体链接）、导出按钮。
- 设置页：基础配置项、依赖检测、登录态提示。

### 11.1 媒体与词云（约定）
- 图片：仅保存原图，列表直接展示图片封面，详情可预览原图（后续可选加缩略图）。
- 视频：仅保存 MP4，不做自动截帧；封面优先用平台返回的封面字段，缺省显示占位图；详情内 `<video>` 播放。
- 词云图：后端生成 PNG 文件（以及词频 JSON），前端直接展示 PNG（如需交互再读取 JSON）。
- 静态文件服务：`/static/notes/{note_id}/...` 对应图片/视频/词云等文件路径。

## 十二、关键实现要点
- 复用现有采集/落库逻辑；Web 仅负责“编排与可视化”。
- 优先“子进程 + stdout 日志解析 + 结果库读取”，避免大改 crawler。
- 进度估算：已处理页/总页（估算）、已落库条数/目标上限。
- 去重：沿用 DB/SQLite upsert；Web 展示“新增/更新”的计数。

## 十三、部署与运维
- 依赖：fastapi、uvicorn、apscheduler、aiosqlite/SQLAlchemy、python-multipart（若上传）、passlib/jose（如后续需要登录）。
- 启动：`python -m uvicorn web.main:app --host 127.0.0.1 --port 8000`。
- Windows 常驻：任务计划/服务（NSSM/WinSW）。
- 日志：按任务/日期切分；定期清理；SQLite 周期性备份。

## 十四、里程碑（建议）
- M1（3-5 天）：MVP（P0）——任务 CRUD、手动运行、实时日志、结果浏览（SQLite 读取）、导出、词云 PNG 显示。
- M2（5-7 天）：调度/并发、取消/重试、更丰富的筛选与导出、运行历史。
- M3（5-7 天）：登录态提示、简报表、告警、代码清理与文档。

## 十五、风险与边界
- Playwright/扫码登录交互：仅能通过子进程弹出浏览器引导扫码。
- 平台反爬变化：需良好日志与重试策略。
- SQLite 并发写：crawler 写库、Web 只读为主；如同时写入需注意连接与事务。


